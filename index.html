<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®è¿›åº¦ç®¡ç†å·¥ä½œå°</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* æ ·å¼ä¸ç”¨æˆ·æä¾›çš„ä¸€è‡´ï¼Œä¿æŒä¸å˜ */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary: #1e3c5c; --accent: #2ecc71; --bg-main: #f0f4fa;
            --card-bg: #ffffff; --border-light: #dde4ec; --text-dark: #1e2b3a;
            --text-muted: #5f6c80; --shadow-card: 0 8px 20px rgba(0,0,0,0.02);
            --radius-lg: 24px;
        }
        body { font-family: 'Inter', sans-serif; background: var(--bg-main); height: 100vh; overflow: hidden; color: var(--text-dark); }
        .container { display: flex; flex-direction: column; height: 100%; }
        .top-bar { background: #13293d; color: white; padding: 0 28px; display: flex; align-items: center; justify-content: space-between; height: 64px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
        .top-bar h1 { font-size: 1.3rem; font-weight: 500; }
        .user-info { display: flex; align-items: center; gap: 15px; color: white; }
        .logout-btn { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.3); padding: 6px 14px; border-radius: 30px; cursor: pointer; font-size: 0.9rem; }
        .logout-btn:hover { background: rgba(255,255,255,0.2); }
        .main-flex { display: flex; flex: 1; overflow: hidden; }
        .sidebar { width: 270px; background: var(--card-bg); border-right: 1px solid var(--border-light); display: flex; flex-direction: column; transition: width 0.2s; overflow: hidden; }
        .sidebar.collapsed { width: 75px; }
        .sidebar-actions { padding: 20px 14px 12px 14px; border-bottom: 1px solid var(--border-light); display: flex; flex-direction: column; gap: 6px; }
        .action-btn { background: none; border: none; display: flex; align-items: center; gap: 14px; padding: 12px 16px; width: 100%; border-radius: 14px; font-size: 0.95rem; font-weight: 500; color: var(--text-dark); cursor: pointer; transition: background 0.15s; white-space: nowrap; }
        .action-btn i { font-size: 1.2rem; width: 24px; }
        .btn-team i { color: #9b59b6; }
        .btn-add i { color: var(--accent); }
        .action-btn:hover { background: #ecf3fa; }
        .sidebar.collapsed .action-btn span { display: none; }
        .sidebar.collapsed .action-btn { justify-content: center; padding: 12px 0; }
        .category-header { padding: 22px 18px 8px 18px; font-size: 0.7rem; text-transform: uppercase; color: var(--text-muted); font-weight: 700; letter-spacing: 0.4px; }
        .category-list { flex: 1; overflow-y: auto; padding: 0 12px 20px 12px; display: flex; flex-direction: column; gap: 2px; }
        .category-item { display: flex; align-items: center; gap: 12px; padding: 12px 18px; border-radius: 12px; cursor: pointer; white-space: nowrap; color: #334155; font-weight: 500; transition: 0.15s; }
        .category-item i { width: 22px; font-size: 1rem; color: var(--primary); opacity: 0.7; }
        .category-item.active { background: #e1effa; color: #0b2b44; font-weight: 600; }
        .category-item.active i { opacity: 1; color: #0b2b44; }
        .category-item:hover:not(.active) { background: #f4f9ff; }
        .sidebar.collapsed .category-item span { display: none; }
        .sidebar.collapsed .category-item { justify-content: center; padding: 14px 0; }
        .content-panel { flex: 1; padding: 28px 32px; overflow-y: auto; }
        .panel-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 28px; }
        .panel-header h2 { font-size: 2.1rem; font-weight: 600; color: #0f2a40; }
        .header-actions { display: flex; align-items: center; gap: 15px; }
        .refresh-btn { background: white; border: 1px solid var(--border-light); padding: 8px 18px; border-radius: 40px; font-size: 0.9rem; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: var(--shadow-card); transition: 0.1s; }
        .refresh-btn:hover { background: #ecf3fa; transform: scale(0.98); }
        .count-badge { background: white; padding: 6px 22px; border-radius: 40px; font-weight: 500; color: var(--primary); box-shadow: var(--shadow-card); }
        .strip-list { display: flex; flex-direction: column; gap: 16px; }
        .strip-card { background: white; border-radius: 30px; padding: 22px 30px; box-shadow: var(--shadow-card); border: 1px solid transparent; display: flex; align-items: center; flex-wrap: wrap; gap: 20px; cursor: pointer; border-left: 6px solid transparent; transition: 0.2s; }
        .strip-card:hover { border-color: #bcd0e5; border-left-color: var(--accent); box-shadow: 0 12px 24px rgba(0,0,0,0.05); transform: translateY(-2px); }
        .card-info { flex: 2; min-width: 260px; }
        .card-title { display: flex; align-items: center; gap: 12px; margin-bottom: 8px; flex-wrap: wrap; }
        .card-title h3 { font-size: 1.3rem; font-weight: 600; }
        .project-badge { font-size: 0.7rem; background: #e6edf5; padding: 4px 12px; border-radius: 30px; color: var(--text-muted); }
        .type-tag { background: #d4e2f0; color: #153e60; font-size: 0.7rem; padding: 4px 14px; border-radius: 30px; font-weight: 600; display: inline-block; margin-top: 6px; }
        .progress-area { flex: 1; min-width: 220px; }
        .progress-meta { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); margin-bottom: 6px; }
        .progress-bg { height: 8px; background: #e2e8f0; border-radius: 20px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), #3498db); width: 0%; transition: width 0.2s; }
        .arrow-icon { color: #9aaebb; font-size: 1.2rem; }
        .empty-state { text-align: center; padding: 70px 20px; background: white; border-radius: 48px; color: var(--text-muted); }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.35); align-items: center; justify-content: center; padding: 20px; z-index: 1000; backdrop-filter: blur(4px); }
        .modal.active { display: flex; }
        .modal-dialog { background: white; border-radius: 36px; width: 100%; max-width: 880px; max-height: 85vh; overflow-y: auto; padding: 32px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }
        .modal-header h3 { font-size: 1.9rem; font-weight: 600; }
        .close-btn { background: none; border: none; font-size: 32px; cursor: pointer; color: #7f8c9f; }
        .detail-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(210px, 1fr)); gap: 18px; margin: 24px 0; }
        .detail-item label { font-size: 0.7rem; font-weight: 600; color: var(--text-muted); text-transform: uppercase; }
        .detail-item .value { background: #f4f9ff; padding: 10px 14px; border-radius: 18px; margin-top: 5px; font-size: 0.95rem; word-break: break-word; }
        .steps-panel { margin: 24px 0 16px; }
        .step-row { display: flex; align-items: center; background: #f4f9ff; border-radius: 40px; padding: 12px 22px; margin-bottom: 10px; border-left: 6px solid #b9c9dd; transition: 0.1s; cursor: pointer; }
        .step-row.done { border-left-color: var(--accent); background: #eafaf1; }
        .step-index { width: 34px; height: 34px; background: white; border-radius: 34px; display: flex; align-items: center; justify-content: center; font-weight: 700; margin-right: 18px; }
        .step-name { flex: 1; font-weight: 500; }
        .step-icon { font-size: 1.4rem; width: 36px; text-align: center; }
        .action-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; }
        .btn-archive { background: #ffc107; color: #212529; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
        .btn-archive:hover { background: #e0a800; }
        .btn-delete { background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
        .btn-delete:hover { background: #c82333; }
        .edit-button { background: var(--primary); color: white; border: none; padding: 10px 20px; border-radius: 30px; cursor: pointer; font-weight: 500; display: inline-flex; align-items: center; gap: 6px; }
        .edit-button:hover { background: #123a57; }
        .form-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin: 20px 0; }
        .form-field { display: flex; flex-direction: column; gap: 6px; }
        .form-field label { font-weight: 600; font-size: 0.8rem; color: var(--text-muted); }
        .form-field input, .form-field select, .form-field textarea { padding: 12px 16px; border: 1px solid var(--border-light); border-radius: 20px; font-size: 0.95rem; background: #fbfdff; transition: 0.15s; }
        .form-field input:focus, .form-field select:focus, .form-field textarea:focus { border-color: var(--primary); outline: none; box-shadow: 0 0 0 3px rgba(30,60,90,0.1); }
        .full-width { grid-column: span 2; }
        .form-actions { display: flex; justify-content: flex-end; gap: 16px; margin-top: 28px; }
        .btn-primary { background: var(--primary); color: white; border: none; padding: 12px 32px; border-radius: 40px; font-weight: 600; cursor: pointer; }
        .btn-secondary { background: #e2e8f0; border: none; padding: 12px 28px; border-radius: 40px; font-weight: 500; cursor: pointer; }
        .loading { text-align: center; padding: 40px; color: var(--text-muted); }
        .error { background: #fee; color: #c00; padding: 12px; border-radius: 20px; margin: 20px 0; text-align: center; }
        .paste-btn { background: none; border: 1px solid var(--border-light); padding: 8px 16px; border-radius: 30px; cursor: pointer; font-size: 0.9rem; display: inline-flex; align-items: center; gap: 6px; margin-left: auto; }
        .paste-btn:hover { background: #f0f4fa; }
        .steps-edit { margin: 20px 0; padding: 16px; background: #f8fafc; border-radius: 24px; }
        .steps-edit .step-row { margin-bottom: 8px; cursor: pointer; }

        /* ç™»å½•æ¨¡æ€æ¡†ä¸“ç”¨æ ·å¼ */
        .login-modal .modal-dialog { max-width: 400px; }
        .login-form { display: flex; flex-direction: column; gap: 20px; padding: 20px 0; }
        .login-field { display: flex; flex-direction: column; gap: 5px; }
        .login-field label { font-weight: 600; color: var(--text-muted); }
        .login-field input { padding: 12px 16px; border: 1px solid var(--border-light); border-radius: 30px; font-size: 1rem; }
        .login-error { color: #dc3545; font-size: 0.9rem; text-align: center; }
        .login-btn { background: var(--primary); color: white; border: none; padding: 14px; border-radius: 30px; font-weight: 600; cursor: pointer; font-size: 1.1rem; }
        .login-btn:hover { background: #123a57; }
    </style>
</head>
<body>
<div class="container">
    <div class="top-bar">
        <h1><i class="fa fa-cloud" style="margin-right: 12px;"></i>é¡¹ç›®è¿›åº¦ç®¡ç†å·¥ä½œå°</h1>
        <div class="user-info" id="userInfo" style="display: none;">
            <span id="usernameDisplay"></span>
            <button class="logout-btn" id="logoutBtn"><i class="fa fa-sign-out-alt"></i> é€€å‡º</button>
        </div>
    </div>
    <div class="main-flex" id="mainApp" style="display: none;">
        <!-- ä¾§è¾¹æ  -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-actions">
                <button class="action-btn" onclick="toggleSidebar()">
                    <i class="fa fa-bars"></i><span>æŠ˜å ä¾§æ </span>
                </button>
                <!-- å›¢é˜Ÿç®¡ç†æŒ‰é’®å·²æ”¹ä¸ºé“¾æ¥ï¼Œç‚¹å‡»åœ¨æ–°æ ‡ç­¾é¡µæ‰“å¼€ https://www.goaoxor.com -->
                <button class="action-btn btn-team" id="teamBtn">
                    <i class="fa fa-users"></i><span>å›¢é˜Ÿç®¡ç†</span>
                </button>
                <button class="action-btn btn-add" id="openNewProjectBtn">
                    <i class="fa fa-plus"></i><span>æ–°å¢é¡¹ç›®</span>
                </button>
            </div>
            <div class="category-header"><i class="fa fa-filter"></i> åˆ†ç±»</div>
            <div class="category-list" id="categoryList"></div>
        </div>

        <!-- å³ä¾§å†…å®¹ -->
        <div class="content-panel">
            <div class="panel-header">
                <h2 id="currentCategoryDisplay">å…¨éƒ¨é¡¹ç›®</h2>
                <div class="header-actions">
                    <button class="refresh-btn" id="refreshBtn"><i class="fa fa-sync-alt"></i> åˆ·æ–°</button>
                    <span class="count-badge" id="projectCount">0 ä¸ª</span>
                </div>
            </div>
            <div id="projectCards" class="strip-list"></div>
            <div id="loadingIndicator" class="loading" style="display:none;"><i class="fa fa-spinner fa-spin"></i> åŠ è½½ä¸­...</div>
            <div id="errorMessage" class="error" style="display:none;"></div>
        </div>
    </div>
</div>

<!-- ç™»å½•æ¨¡æ€æ¡† -->
<div class="modal active" id="loginModal">
    <div class="modal-dialog login-modal">
        <div class="modal-header">
            <h3><i class="fa fa-lock"></i> è¯·ç™»å½•</h3>
        </div>
        <div class="modal-body">
            <div class="login-form">
                <div class="login-field">
                    <label>ç”¨æˆ·å</label>
                    <input type="text" id="loginUsername" placeholder="è¾“å…¥ç”¨æˆ·å">
                </div>
                <div class="login-field">
                    <label>å¯†ç </label>
                    <input type="password" id="loginPassword" placeholder="è¾“å…¥å¯†ç ">
                </div>
                <div class="login-error" id="loginError"></div>
                <button class="login-btn" id="loginBtn"><i class="fa fa-sign-in-alt"></i> ç™»å½•</button>
            </div>
        </div>
    </div>
</div>

<!-- è¯¦æƒ…æ¨¡æ€æ¡†ï¼ˆåŒ…å«å½’æ¡£å’Œåˆ é™¤æŒ‰é’®ï¼‰ -->
<div class="modal" id="detailModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3 id="detailTitle">é¡¹ç›®è¯¦æƒ…</h3>
            <button class="close-btn" id="closeDetailBtn">&times;</button>
        </div>
        <div class="modal-body" id="detailBody"></div>
        <div class="action-buttons">
            <button class="btn-archive" id="archiveProjectBtn"><i class="fa fa-archive"></i> å½’æ¡£</button>
            <button class="btn-delete" id="deleteProjectBtn"><i class="fa fa-trash"></i> åˆ é™¤</button>
            <button class="edit-button" id="editProjectBtn"><i class="fa fa-pen"></i> ç¼–è¾‘</button>
        </div>
    </div>
</div>

<!-- æ–°å¢/ç¼–è¾‘æ¨¡æ€æ¡†ï¼ˆåŒ…å«æ­¥éª¤è°ƒèŠ‚å’Œç²˜è´´æ–‡æœ¬ï¼‰ -->
<div class="modal" id="editModal">
    <div class="modal-dialog">
        <div class="modal-header">
            <h3 id="editModalTitle">æ–°å¢é¡¹ç›®</h3>
            <div style="display: flex; gap: 10px;">
                <button class="paste-btn" id="pasteTextBtn"><i class="fa fa-paste"></i> ç²˜è´´æ–‡æœ¬</button>
                <button class="close-btn" id="closeEditBtn">&times;</button>
            </div>
        </div>
        <div class="modal-body">
            <form id="projectForm" onsubmit="return false;">
                <div class="form-grid">
                    <div class="form-field">
                        <label>ğŸ‘¤ å§“å/å…¬å¸ *</label>
                        <input type="text" id="submitter" name="submitter" required placeholder="ä¾‹ï¼šå¼ ä¸‰ / è”šæ¥ç§‘æŠ€">
                    </div>
                    <div class="form-field">
                        <label>ğŸ“§ é‚®ç®±</label>
                        <input type="email" id="email" name="email" placeholder="client@example.com">
                    </div>
                    <div class="form-field">
                        <label>ğŸ·ï¸ åˆ†ç±» *</label>
                        <select id="type" name="type" required></select>
                    </div>
                    <div class="form-field">
                        <label>ğŸ“… æˆªæ­¢æ—¥æœŸ</label>
                        <input type="date" id="deadline" name="deadline">
                    </div>
                    <div class="form-field full-width">
                        <label>ğŸ“ é¡¹ç›®æè¿°</label>
                        <textarea id="description" name="description" rows="2"></textarea>
                    </div>
                    <div class="form-field">
                        <label>ğŸ¯ é¡¹ç›®ç›®æ ‡</label>
                        <input type="text" id="goal" name="goal">
                    </div>
                    <div class="form-field">
                        <label>ğŸ‘¥ ç›®æ ‡å—ä¼—</label>
                        <input type="text" id="audience" name="audience">
                    </div>
                    <div class="form-field">
                        <label>ğŸ”— å‚è€ƒèµ„æ–™</label>
                        <input type="text" id="references" name="references">
                    </div>
                    <div class="form-field">
                        <label>ğŸš¨ ä¼˜å…ˆçº§</label>
                        <input type="text" id="priority" name="priority" placeholder="é«˜/ä¸­/ä½">
                    </div>
                    <div class="form-field">
                        <label>ğŸ’° é¢„ç®—èŒƒå›´</label>
                        <input type="text" id="budget" name="budget">
                    </div>
                    <div class="form-field">
                        <label>ğŸ“ è”ç³»æ–¹å¼</label>
                        <input type="text" id="contact" name="contact">
                    </div>
                    <div class="form-field full-width">
                        <label>ğŸ“„ é¢å¤–è¯´æ˜</label>
                        <textarea id="extra" name="extra" rows="2"></textarea>
                    </div>
                </div>

                <!-- æ­¥éª¤è°ƒèŠ‚åŒº -->
                <div class="steps-edit">
                    <strong><i class="fa fa-list-check"></i> é¡¹ç›®æ­¥éª¤ï¼ˆç‚¹å‡»åˆ‡æ¢å®ŒæˆçŠ¶æ€ï¼‰</strong>
                    <div id="stepsEditContainer" class="steps-container"></div>
                </div>

                <input type="hidden" id="projectId" name="projectId">
                <div class="form-actions">
                    <button type="button" class="btn-secondary" id="cancelEditBtn">å–æ¶ˆ</button>
                    <button type="submit" class="btn-primary" id="saveProjectBtn">ä¿å­˜é¡¹ç›®</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    (function() {
        // ----- é…ç½® -----
        const API_BASE = 'https://project-management-api.yonglamlongway.workers.dev';
        const LOGIN_API = API_BASE + '/login';
        const FIXED_CATEGORIES = [
            "å…¨éƒ¨", "äº§å“å®£ä¼ è§†é¢‘", "å¹¿å‘Šè§†é¢‘", "è§£è¯´åŠ¨ç”»", "YouTubeå‰ªè¾‘",
            "æ ‡å¿—è®¾è®¡", "å“ç‰Œè§†è§‰ç³»ç»Ÿ", "åŒ…è£…è®¾è®¡", "ç€é™†é¡µè§†è§‰", "å…¶ä»–"
        ];
        const EN_TO_CN = {
            "Product Promo Video": "äº§å“å®£ä¼ è§†é¢‘",
            "Advertising Video": "å¹¿å‘Šè§†é¢‘",
            "Explainer Animation": "è§£è¯´åŠ¨ç”»",
            "YouTube Editing": "YouTubeå‰ªè¾‘",
            "Logo Design": "æ ‡å¿—è®¾è®¡",
            "Brand Visual System": "å“ç‰Œè§†è§‰ç³»ç»Ÿ",
            "Packaging Design": "åŒ…è£…è®¾è®¡",
            "Landing Page Visual": "ç€é™†é¡µè§†è§‰"
        };

        // ----- çŠ¶æ€ -----
        let projects = [];
        let currentCategory = "å…¨éƒ¨";
        let currentDetailProjectId = null;
        let editMode = 'new';
        let editSteps = [];
        let token = localStorage.getItem('project_token'); // ä»localStorageè¯»å–token

        // DOM å…ƒç´ 
        const loginModal = document.getElementById('loginModal');
        const mainApp = document.getElementById('mainApp');
        const userInfo = document.getElementById('userInfo');
        const usernameDisplay = document.getElementById('usernameDisplay');
        const logoutBtn = document.getElementById('logoutBtn');
        const loginBtn = document.getElementById('loginBtn');
        const loginUsername = document.getElementById('loginUsername');
        const loginPassword = document.getElementById('loginPassword');
        const loginError = document.getElementById('loginError');

        const loadingEl = document.getElementById('loadingIndicator');
        const errorEl = document.getElementById('errorMessage');
        const projectCardsEl = document.getElementById('projectCards');
        const categoryListEl = document.getElementById('categoryList');
        const currentCategoryDisplay = document.getElementById('currentCategoryDisplay');
        const projectCountEl = document.getElementById('projectCount');
        const stepsEditContainer = document.getElementById('stepsEditContainer');
        const refreshBtn = document.getElementById('refreshBtn');

        // ----- å·¥å…·å‡½æ•° -----
        function showLoading(show) {
            loadingEl.style.display = show ? 'block' : 'none';
        }
        function showError(msg) {
            if (msg) {
                errorEl.style.display = 'block';
                errorEl.innerText = msg;
            } else {
                errorEl.style.display = 'none';
            }
        }

        // å®‰å…¨è§£æ steps
        function safeParseSteps(stepsField) {
            if (!stepsField) return [];
            if (Array.isArray(stepsField)) return stepsField;
            if (typeof stepsField === 'string') {
                try {
                    const parsed = JSON.parse(stepsField);
                    return Array.isArray(parsed) ? parsed : [];
                } catch {
                    return [];
                }
            }
            return [];
        }

        function calcProgress(steps) {
            const stepsArray = safeParseSteps(steps);
            if (stepsArray.length === 0) return 0;
            const done = stepsArray.filter(s => s && s.status === 'done').length;
            return Math.round((done / stepsArray.length) * 100);
        }

        function normalizeProject(p) {
            return {
                ...p,
                steps: safeParseSteps(p.steps),
                submitter: p.submitter || p.name || '',
            };
        }

        function parseProjectText(text) {
            const lines = text.split(/\r?\n/);
            const data = {
                submitter: '', email: '', type: 'å…¶ä»–', description: '', goal: '',
                audience: '', references: '', deadline: '', priority: '',
                budget: '', contact: '', extra: '',
            };
            lines.forEach(line => {
                if (line.includes('ğŸ‘¤')) data.submitter = line.split(':')[1]?.trim() || data.submitter;
                if (line.includes('ğŸ“§')) data.email = line.split(':')[1]?.trim() || data.email;
                if (line.includes('ğŸ·ï¸')) {
                    const raw = line.split(':')[1]?.trim() || '';
                    data.type = EN_TO_CN[raw] || (FIXED_CATEGORIES.includes(raw) ? raw : 'å…¶ä»–');
                }
                if (line.includes('ğŸ“')) data.description = line.split(':')[1]?.trim() || data.description;
                if (line.includes('ğŸ¯')) data.goal = line.split(':')[1]?.trim() || data.goal;
                if (line.includes('ğŸ‘¥')) data.audience = line.split(':')[1]?.trim() || data.audience;
                if (line.includes('ğŸ”—')) data.references = line.split(':')[1]?.trim() || data.references;
                if (line.includes('ğŸ“…')) data.deadline = line.split(':')[1]?.trim() || data.deadline;
                if (line.includes('ğŸš¨')) data.priority = line.split(':')[1]?.trim() || data.priority;
                if (line.includes('ğŸ’°')) data.budget = line.split(':')[1]?.trim() || data.budget;
                if (line.includes('ğŸ“')) data.contact = line.split(':')[1]?.trim() || data.contact;
                if (line.includes('ğŸ“„')) data.extra = line.split(':')[1]?.trim() || data.extra;
            });
            return data;
        }

        // ----- å¸¦è®¤è¯çš„ fetch å°è£… -----
        async function authenticatedFetch(url, options = {}) {
            if (!token) {
                showLoginModal();
                throw new Error('æœªç™»å½•');
            }
            const headers = {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`,
                ...(options.headers || {})
            };
            const res = await fetch(url, { ...options, headers });
            if (res.status === 401) {
                localStorage.removeItem('project_token');
                token = null;
                showLoginModal();
                throw new Error('ç™»å½•å·²è¿‡æœŸï¼Œè¯·é‡æ–°ç™»å½•');
            }
            return res;
        }

        // ----- ç™»å½•åŠŸèƒ½ -----
        function showLoginModal() {
            mainApp.style.display = 'none';
            userInfo.style.display = 'none';
            loginModal.classList.add('active');
        }

        function hideLoginModal() {
            loginModal.classList.remove('active');
            mainApp.style.display = 'flex';
            userInfo.style.display = 'flex';
        }

        async function handleLogin() {
            const username = loginUsername.value.trim();
            const password = loginPassword.value.trim();
            if (!username || !password) {
                loginError.innerText = 'è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ';
                return;
            }
            loginError.innerText = '';
            try {
                const res = await fetch(LOGIN_API, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                const data = await res.json();
                if (!res.ok || !data.success) {
                    throw new Error(data.error || 'ç™»å½•å¤±è´¥');
                }
                token = data.token;
                localStorage.setItem('project_token', token);
                usernameDisplay.innerText = username;
                hideLoginModal();
                fetchProjects();
            } catch (err) {
                loginError.innerText = err.message;
            }
        }

        function handleLogout() {
            localStorage.removeItem('project_token');
            token = null;
            showLoginModal();
        }

        // ----- API è°ƒç”¨ï¼ˆä½¿ç”¨ authenticatedFetchï¼‰-----
        async function fetchProjects() {
            showLoading(true);
            showError(null);
            try {
                const res = await authenticatedFetch(`${API_BASE}/projects`);
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'åŠ è½½å¤±è´¥');
                projects = (data.projects || []).map(normalizeProject);
                renderCategories();
                renderProjectCards();

                if (currentDetailProjectId) {
                    const updatedProj = projects.find(p => p.id === currentDetailProjectId);
                    if (updatedProj) {
                        openDetailModal(updatedProj);
                    } else {
                        document.getElementById('detailModal').classList.remove('active');
                        currentDetailProjectId = null;
                    }
                }
            } catch (err) {
                showError('åŠ è½½é¡¹ç›®å¤±è´¥ï¼š' + err.message);
                projects = [];
                renderCategories();
                renderProjectCards();
            } finally {
                showLoading(false);
            }
        }

        async function saveProjectToAPI(projectData, isNew) {
            const url = isNew ? `${API_BASE}/projects` : `${API_BASE}/projects`;
            const method = isNew ? 'POST' : 'PUT';
            const bodyData = { ...projectData };
            if (bodyData.steps && Array.isArray(bodyData.steps)) {
                bodyData.steps = JSON.stringify(bodyData.steps);
            }
            if (!bodyData.name) bodyData.name = bodyData.submitter || '';

            const res = await authenticatedFetch(url, {
                method,
                body: JSON.stringify(bodyData)
            });
            if (!res.ok) throw new Error(`HTTP ${res.status}`);
            const data = await res.json();
            if (!data.success) throw new Error(data.error || 'ä¿å­˜å¤±è´¥');
            return data;
        }

        async function archiveProject(projectId) {
            if (!projectId) return;
            try {
                const res = await authenticatedFetch(`${API_BASE}/archive`, {
                    method: 'PUT',
                    body: JSON.stringify({ id: projectId })
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'å½’æ¡£å¤±è´¥');
                await fetchProjects();
                alert('é¡¹ç›®å·²å½’æ¡£');
            } catch (err) {
                alert('å½’æ¡£å¤±è´¥ï¼š' + err.message);
            }
        }

        async function deleteProject(projectId, projectName) {
            const confirmName = prompt(`è¯·è¾“å…¥é¡¹ç›®åç§° "${projectName}" ä»¥ç¡®è®¤åˆ é™¤ï¼š`);
            if (!confirmName) return;

            try {
                const res = await authenticatedFetch(`${API_BASE}/projects`, {
                    method: 'DELETE',
                    body: JSON.stringify({ id: projectId, confirmName: confirmName })
                });
                if (!res.ok) throw new Error(`HTTP ${res.status}`);
                const data = await res.json();
                if (!data.success) throw new Error(data.error || 'åˆ é™¤å¤±è´¥');
                await fetchProjects();
                alert('é¡¹ç›®å·²åˆ é™¤');
            } catch (err) {
                alert('åˆ é™¤å¤±è´¥ï¼š' + err.message);
            }
        }

        // ----- æ¸²æŸ“å‡½æ•° -----
        function renderCategories() {
            categoryListEl.innerHTML = '';
            FIXED_CATEGORIES.forEach(cat => {
                const div = document.createElement('div');
                div.className = `category-item ${currentCategory === cat ? 'active' : ''}`;
                div.dataset.cat = cat;
                div.innerHTML = `<i class="fa fa-folder${cat==='å…¨éƒ¨'?'-open':''}"></i><span>${cat}</span>`;
                div.addEventListener('click', () => {
                    if (currentCategory === cat) return;
                    currentCategory = cat;
                    renderCategories();
                    renderProjectCards();
                    currentCategoryDisplay.innerText = cat;
                });
                categoryListEl.appendChild(div);
            });
        }

        function getFilteredProjects() {
            if (currentCategory === "å…¨éƒ¨") return projects;
            if (currentCategory === "å…¶ä»–") {
                const normalCats = FIXED_CATEGORIES.filter(c => c !== "å…¨éƒ¨" && c !== "å…¶ä»–");
                return projects.filter(p => !normalCats.includes(p.type));
            }
            return projects.filter(p => p.type === currentCategory);
        }

        function renderProjectCards() {
            const filtered = getFilteredProjects();
            projectCountEl.innerText = filtered.length + " ä¸ª";

            if (filtered.length === 0) {
                projectCardsEl.innerHTML = `<div class="empty-state"><i class="fa fa-folder-open fa-3x" style="margin-bottom:16px;"></i><h3>è¿™ä¸ªåˆ†ç±»æš‚æ— é¡¹ç›®</h3><p>ç‚¹å‡»â€œæ–°å¢é¡¹ç›®â€æ‰‹åŠ¨åˆ›å»º</p></div>`;
                return;
            }

            projectCardsEl.innerHTML = filtered.map(proj => {
                const progress = calcProgress(proj.steps);
                const stepsArray = safeParseSteps(proj.steps);
                const doneCount = stepsArray.filter(s => s?.status === 'done').length;
                return `
                    <div class="strip-card" data-id="${proj.id}">
                        <div class="card-info">
                            <div class="card-title">
                                <h3>${proj.submitter || 'æœªå‘½å'}</h3>
                                <span class="project-badge">${proj.id}</span>
                            </div>
                            <span class="type-tag"><i class="fa fa-tag"></i> ${proj.type || 'å…¶ä»–'}</span>
                        </div>
                        <div class="progress-area">
                            <div class="progress-meta">
                                <span>è¿›åº¦ ${progress}%</span>
                                <span>${doneCount}/${stepsArray.length}</span>
                            </div>
                            <div class="progress-bg">
                                <div class="progress-fill" style="width:${progress}%;"></div>
                            </div>
                        </div>
                        <div class="arrow-icon"><i class="fa fa-arrow-right"></i></div>
                    </div>
                `;
            }).join('');

            document.querySelectorAll('.strip-card').forEach(card => {
                card.addEventListener('click', () => {
                    const id = card.dataset.id;
                    const project = projects.find(p => p.id === id);
                    if (project) openDetailModal(project);
                });
            });
        }

        async function openDetailModal(project) {
            currentDetailProjectId = project.id;
            const modal = document.getElementById('detailModal');
            document.getElementById('detailTitle').innerText = project.submitter || 'é¡¹ç›®è¯¦æƒ…';

            const stepsArray = safeParseSteps(project.steps);
            const stepsHtml = stepsArray.map((step, idx) => {
                const done = step?.status === 'done' ? 'done' : '';
                const icon = step?.status === 'done' ? 'âœ…' : 'â—»ï¸';
                return `<div class="step-row ${done}" data-step-index="${idx}"><span class="step-index">${idx+1}</span><span class="step-name">${step?.name || 'æ­¥éª¤' + (idx+1)}</span><span class="step-icon">${icon}</span></div>`;
            }).join('');

            document.getElementById('detailBody').innerHTML = `
                <div class="detail-grid">
                    <div class="detail-item"><label>é¡¹ç›®ç¼–ç </label><div class="value">${project.id}</div></div>
                    <div class="detail-item"><label>ğŸ‘¤ å§“å/å…¬å¸</label><div class="value">${project.submitter || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸ“§ é‚®ç®±</label><div class="value">${project.email || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸ·ï¸ åˆ†ç±»</label><div class="value">${project.type || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸ“… æˆªæ­¢æ—¥æœŸ</label><div class="value">${project.deadline || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸš¨ ä¼˜å…ˆçº§</label><div class="value">${project.priority || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸ’° é¢„ç®—</label><div class="value">${project.budget || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸ“ è”ç³»æ–¹å¼</label><div class="value">${project.contact || 'â€”'}</div></div>
                    <div class="detail-item full-width"><label>ğŸ“ æè¿°</label><div class="value">${project.description || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸ¯ ç›®æ ‡</label><div class="value">${project.goal || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸ‘¥ å—ä¼—</label><div class="value">${project.audience || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸ”— å‚è€ƒèµ„æ–™</label><div class="value">${project.references || 'â€”'}</div></div>
                    <div class="detail-item"><label>ğŸ“„ è¡¥å……</label><div class="value">${project.extra || 'â€”'}</div></div>
                </div>
                <div class="steps-panel"><strong>è¿›åº¦è°ƒèŠ‚ (ç‚¹å‡»åˆ‡æ¢)</strong></div>
                <div class="steps-container">${stepsHtml}</div>
            `;

            setTimeout(() => {
                document.querySelectorAll('#detailBody .step-row').forEach(row => {
                    row.addEventListener('click', async (e) => {
                        e.stopPropagation();
                        const idx = row.dataset.stepIndex;
                        const proj = projects.find(p => p.id === currentDetailProjectId);
                        if (!proj) return;
                        const steps = safeParseSteps(proj.steps);
                        steps[idx].status = steps[idx].status === 'done' ? 'pending' : 'done';
                        proj.steps = steps;
                        try {
                            await saveProjectToAPI(proj, false);
                            await fetchProjects();
                        } catch (err) {
                            alert('æ›´æ–°æ­¥éª¤å¤±è´¥ï¼š' + err.message);
                        }
                    });
                });
            }, 30);

            modal.classList.add('active');
        }

        function renderEditSteps(stepsArray) {
            if (!stepsEditContainer) return;
            stepsEditContainer.innerHTML = stepsArray.map((step, idx) => {
                const done = step?.status === 'done' ? 'done' : '';
                const icon = step?.status === 'done' ? 'âœ…' : 'â—»ï¸';
                return `<div class="step-row ${done}" data-step-index="${idx}">
                    <span class="step-index">${idx+1}</span>
                    <span class="step-name">${step?.name || 'æ­¥éª¤' + (idx+1)}</span>
                    <span class="step-icon">${icon}</span>
                </div>`;
            }).join('');

            stepsEditContainer.querySelectorAll('.step-row').forEach(row => {
                row.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const idx = row.dataset.stepIndex;
                    if (editSteps[idx]) {
                        editSteps[idx].status = editSteps[idx].status === 'done' ? 'pending' : 'done';
                        renderEditSteps(editSteps);
                    }
                });
            });
        }

        function openEditModal(project = null) {
            const modal = document.getElementById('editModal');
            const form = document.getElementById('projectForm');
            form.reset();
            document.getElementById('projectId').value = '';

            const typeSelect = document.getElementById('type');
            typeSelect.innerHTML = '';
            FIXED_CATEGORIES.filter(c => c !== 'å…¨éƒ¨').forEach(cat => {
                const opt = document.createElement('option');
                opt.value = cat;
                opt.textContent = cat;
                typeSelect.appendChild(opt);
            });

            if (project) {
                editMode = 'edit';
                document.getElementById('editModalTitle').innerText = 'ç¼–è¾‘é¡¹ç›®';
                document.getElementById('projectId').value = project.id;
                document.getElementById('submitter').value = project.submitter || '';
                document.getElementById('email').value = project.email || '';
                document.getElementById('type').value = project.type || 'å…¶ä»–';
                document.getElementById('deadline').value = project.deadline || '';
                document.getElementById('description').value = project.description || '';
                document.getElementById('goal').value = project.goal || '';
                document.getElementById('audience').value = project.audience || '';
                document.getElementById('references').value = project.references || '';
                document.getElementById('priority').value = project.priority || '';
                document.getElementById('budget').value = project.budget || '';
                document.getElementById('contact').value = project.contact || '';
                document.getElementById('extra').value = project.extra || '';

                const parsedSteps = safeParseSteps(project.steps);
                if (parsedSteps.length > 0) {
                    editSteps = parsedSteps.map(s => ({ ...s }));
                } else {
                    editSteps = [
                        { name: 'éœ€æ±‚æ²Ÿé€š', status: 'pending' },
                        { name: 'åˆ›æ„æ–¹æ¡ˆ', status: 'pending' },
                        { name: 'æ‰§è¡Œåˆ¶ä½œ', status: 'pending' },
                        { name: 'å®¢æˆ·åé¦ˆ', status: 'pending' },
                        { name: 'äº¤ä»˜ç»“é¡¹', status: 'pending' }
                    ];
                }
            } else {
                editMode = 'new';
                document.getElementById('editModalTitle').innerText = 'æ–°å¢é¡¹ç›®';
                typeSelect.value = FIXED_CATEGORIES[1];
                editSteps = [
                    { name: 'éœ€æ±‚æ²Ÿé€š', status: 'pending' },
                    { name: 'åˆ›æ„æ–¹æ¡ˆ', status: 'pending' },
                    { name: 'æ‰§è¡Œåˆ¶ä½œ', status: 'pending' },
                    { name: 'å®¢æˆ·åé¦ˆ', status: 'pending' },
                    { name: 'äº¤ä»˜ç»“é¡¹', status: 'pending' }
                ];
            }
            renderEditSteps(editSteps);
            modal.classList.add('active');
        }

        function pasteTextAndFill() {
            const text = prompt('è¯·ç²˜è´´å®¢æˆ·è¡¨å•æ–‡æœ¬ï¼ˆåŒ…å«ğŸ‘¤ã€ğŸ·ï¸ç­‰ï¼‰:');
            if (!text) return;
            const parsed = parseProjectText(text);
            document.getElementById('submitter').value = parsed.submitter || '';
            document.getElementById('email').value = parsed.email || '';
            if (parsed.type && FIXED_CATEGORIES.includes(parsed.type)) {
                document.getElementById('type').value = parsed.type;
            }
            document.getElementById('description').value = parsed.description || '';
            document.getElementById('goal').value = parsed.goal || '';
            document.getElementById('audience').value = parsed.audience || '';
            document.getElementById('references').value = parsed.references || '';
            document.getElementById('deadline').value = parsed.deadline || '';
            document.getElementById('priority').value = parsed.priority || '';
            document.getElementById('budget').value = parsed.budget || '';
            document.getElementById('contact').value = parsed.contact || '';
            document.getElementById('extra').value = parsed.extra || '';
        }

        async function saveProject(formData) {
            const id = formData.get('projectId');
            const submitter = formData.get('submitter');
            if (!submitter) {
                alert('å§“å/å…¬å¸ä¸èƒ½ä¸ºç©º');
                return false;
            }

            let projectData = {
                id: id || undefined,
                name: submitter,
                submitter: submitter,
                email: formData.get('email') || '',
                type: formData.get('type') || 'å…¶ä»–',
                deadline: formData.get('deadline') || '',
                description: formData.get('description') || '',
                goal: formData.get('goal') || '',
                audience: formData.get('audience') || '',
                references: formData.get('references') || '',
                priority: formData.get('priority') || '',
                budget: formData.get('budget') || '',
                contact: formData.get('contact') || '',
                extra: formData.get('extra') || '',
                submit_time: new Date().toISOString(),
                status: 'é¢„å¤‡ä¸­',
                steps: editSteps
            };

            try {
                const isNew = (editMode === 'new');
                await saveProjectToAPI(projectData, isNew);
                await fetchProjects();
                return true;
            } catch (err) {
                alert('ä¿å­˜å¤±è´¥ï¼š' + err.message);
                return false;
            }
        }

        // ----- åˆå§‹åŒ–ä¸äº‹ä»¶ç»‘å®š -----
        document.addEventListener('DOMContentLoaded', function() {
            // ç™»å½•æŒ‰é’®äº‹ä»¶
            loginBtn.addEventListener('click', handleLogin);
            loginUsername.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            loginPassword.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });
            logoutBtn.addEventListener('click', handleLogout);

            // å¦‚æœå·²æœ‰tokenï¼Œå°è¯•åŠ è½½æ•°æ®
            if (token) {
                hideLoginModal();
                fetchProjects();
            } else {
                showLoginModal();
            }

            // å…¶ä»–æŒ‰é’®äº‹ä»¶
            document.getElementById('openNewProjectBtn').addEventListener('click', () => openEditModal(null));
            
            // ã€ä¿®æ”¹ç‚¹ã€‘å›¢é˜Ÿç®¡ç†æŒ‰é’®æ”¹ä¸ºæ‰“å¼€é“¾æ¥ https://www.goaoxor.com
            document.getElementById('teamBtn').addEventListener('click', () => {
                window.open('https://www.goaoxor.com', '_blank');
            });

            document.getElementById('pasteTextBtn').addEventListener('click', pasteTextAndFill);
            refreshBtn.addEventListener('click', fetchProjects);

            document.getElementById('archiveProjectBtn').addEventListener('click', () => {
                if (currentDetailProjectId) {
                    archiveProject(currentDetailProjectId);
                }
            });
            document.getElementById('deleteProjectBtn').addEventListener('click', () => {
                if (currentDetailProjectId) {
                    const project = projects.find(p => p.id === currentDetailProjectId);
                    if (project) {
                        deleteProject(currentDetailProjectId, project.submitter || project.name);
                    }
                }
            });
            document.getElementById('editProjectBtn').addEventListener('click', ()=>{
                if (!currentDetailProjectId) return;
                const project = projects.find(p => p.id === currentDetailProjectId);
                if (project) openEditModal(project);
            });

            document.getElementById('closeDetailBtn').addEventListener('click', ()=>{
                document.getElementById('detailModal').classList.remove('active');
                currentDetailProjectId = null;
            });
            window.addEventListener('click', (e) => {
                const detailModal = document.getElementById('detailModal');
                const editModal = document.getElementById('editModal');
                if (e.target === detailModal) {
                    detailModal.classList.remove('active');
                    currentDetailProjectId = null;
                }
                if (e.target === editModal) {
                    editModal.classList.remove('active');
                }
            });

            document.getElementById('closeEditBtn').addEventListener('click', ()=>{
                document.getElementById('editModal').classList.remove('active');
            });
            document.getElementById('cancelEditBtn').addEventListener('click', ()=>{
                document.getElementById('editModal').classList.remove('active');
            });

            document.getElementById('projectForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const formData = new FormData(this);
                const success = await saveProject(formData);
                if (success) {
                    document.getElementById('editModal').classList.remove('active');
                }
            });
        });

        window.toggleSidebar = function() {
            document.getElementById('sidebar').classList.toggle('collapsed');
        };
    })();
</script>
</body>
</html>
